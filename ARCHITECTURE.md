# Transmission Tower Optimization System - Complete Architecture

## ğŸ“‹ Table of Contents
1. [API Endpoints Analysis](#api-endpoints-analysis)
2. [System Architecture Overview](#system-architecture-overview)
3. [Data Flow & Processing Pipeline](#data-flow--processing-pipeline)
4. [Component Interactions](#component-interactions)
5. [Calculation Engines](#calculation-engines)
6. [Output Generation](#output-generation)

---

## ğŸ”Œ API Endpoints Analysis

### **Existing Endpoints**

| Method | Endpoint | Purpose | Status |
|--------|----------|---------|--------|
| `GET` | `/` | Root endpoint with API info | âœ… Complete |
| `GET` | `/health` | Health check | âœ… Complete |
| `POST` | `/optimize` | Single-tower or route optimization | âœ… Complete |
| `POST` | `/optimize/route` | Route-level optimization (alternative entry) | âœ… Complete |
| `POST` | `/validate-design` | Real-time design validation | âœ… Complete |

### **Missing/Potentially Useful Endpoints**

| Endpoint | Purpose | Priority | Notes |
|----------|---------|----------|-------|
| `GET /docs` | OpenAPI/Swagger documentation | ğŸ”´ High | FastAPI auto-generates this, but may need explicit route |
| `GET /api/standards` | List available design standards | ğŸŸ¡ Medium | Useful for frontend dropdowns |
| `GET /api/market-rates/{country_code}` | Get market rates for country | ğŸŸ¡ Medium | Could be useful for preview |
| `GET /api/geo-context?lat={lat}&lon={lon}` | Get geographic context for coordinates | ğŸŸ¡ Medium | Useful for map interactions |
| `POST /api/export/pdf` | Generate PDF report | ğŸŸ¢ Low | Nice-to-have feature |
| `GET /api/projects` | List saved projects | ğŸŸ¢ Low | Requires database |
| `POST /api/projects` | Save project | ğŸŸ¢ Low | Requires database |
| `DELETE /api/projects/{id}` | Delete saved project | ğŸŸ¢ Low | Requires database |

**Note**: `/optimize` and `/optimize/route` are functionally similar - `/optimize` automatically detects route data and routes to route optimization internally.

---

## ğŸ—ï¸ System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FRONTEND LAYER                                â”‚
â”‚                         (Next.js 16 + React 19)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ Landing Page â”‚  â”‚  Form Input  â”‚  â”‚   Results    â”‚                   â”‚
â”‚  â”‚  Component   â”‚â†’ â”‚  Component   â”‚â†’ â”‚  Component   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â”‚                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                    â”‚   API Client  â”‚                                    â”‚
â”‚                    â”‚  (lib/api.ts) â”‚                                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                            â”‚                                            â”‚
â”‚                    HTTP POST/GET                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Port 8000
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKEND LAYER                                    â”‚
â”‚                    (FastAPI + Python 3.12)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                    API ROUTER (api.py)                        â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚      â”‚
â”‚  â”‚  â”‚   GET /  â”‚  â”‚ GET /healthâ”‚ â”‚POST /optimizeâ”‚ â”‚POST /validateâ”‚      â”‚      
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚              SERVICE LAYER (backend/services/)                â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚         optimizer_service.py                        â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Parses input parameters                          â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Routes to single-tower OR route optimization     â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Returns canonical format                         â”‚      â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚         route_optimizer.py                          â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Orchestrates full route optimization              â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Calls SectionBasedPlacer for tower placement      â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Calls PSO optimizer for each tower                â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Aggregates results                                â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚      section_based_placer.py                        â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Phase 1: Corner Merging (< 50m segments)         â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Phase 2: Define Sections                         â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Phase 3: Optimize Spans (with slack logic)       â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Phase 4: Precise Placement (vector math)         â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Integrates ObstacleDetector for smart nudging    â”‚      â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚         obstacle_detector.py                        â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Queries OSM Overpass API (rivers, roads, etc.)   â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Analyzes terrain slopes (> 30% = forbidden)      â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Creates ForbiddenZone objects                     â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ get_safe_spot() - nudges towers away from zones   â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚         pso_optimizer.py                             â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Particle Swarm Optimization algorithm             â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Explores design space (height, width, span)      â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Calls CodalEngine for safety validation          â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Calls CostEngine for cost calculation            â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Returns cheapest SAFE design                      â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚         codal_engine/ (IS, IEC, Eurocode, ASCE)     â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Implements design standard-specific rules        â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Checks electrical clearance                      â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Validates structural safety                      â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Uses ClearanceResolver for voltage-aware rules   â”‚      â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚      â”‚
â”‚  â”‚  â”‚         cost_engine.py                               â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Reads market_rates.py for regional costs          â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Calculates steel, foundation, erection costs      â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Applies labor and logistics factors               â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Returns cost breakdown with market rates          â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚      â”‚
â”‚  â”‚                            â”‚                                  â”‚      â”‚
â”‚  â”‚                            â–¼                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”‚
â”‚  â”‚  â”‚         canonical_converter.py                      â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Converts OptimizationResult to canonical format  â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Adds line summary, cost breakdown, safety        â”‚      â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ Includes regional context, currency              â”‚      â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚  Supporting Services:                                         â”‚      â”‚
â”‚  â”‚  â€¢ location_deriver.py - Reverse geocoding, country detection â”‚      â”‚
â”‚  â”‚  â€¢ standard_resolver.py - Design standard resolution          â”‚      â”‚
â”‚  â”‚  â€¢ clearance_rules.py - Voltage-aware clearance rules         â”‚      â”‚
â”‚  â”‚  â€¢ currency_resolver.py - Currency conversion (USD/INR)       â”‚      â”‚
â”‚  â”‚  â€¢ tower_type_classifier.py - Classifies tower types          â”‚      â”‚
â”‚  â”‚  â€¢ design_validator.py - Post-optimization validation         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow & Processing Pipeline

### **Complete Request-Response Flow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: USER INPUT (Frontend)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  User fills form:
â”‚  â€¢ Voltage (kV)
â”‚  â€¢ Terrain type
â”‚  â€¢ Wind zone
â”‚  â€¢ Soil category
â”‚  â€¢ Tower type
â”‚  â€¢ Route coordinates (optional)
â”‚  â€¢ Terrain profile (optional)
â”‚  â€¢ Project length (km)
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 2: PAYLOAD NORMALIZATION (lib/api.ts)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  normalizePayload():
â”‚  â€¢ Validates enum values (terrain, wind, soil, tower)
â”‚  â€¢ Converts voltage to integer
â”‚  â€¢ Formats route_coordinates
â”‚  â€¢ Formats terrain_profile: [{x: distance_m, z: elevation_m}]
â”‚  â€¢ Adds geo_context if available
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 3: API REQUEST (POST /optimize)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  FastAPI receives OptimizationRequest
â”‚  â€¢ Pydantic validates schema
â”‚  â€¢ Converts to dict format
â”‚  â€¢ Calls run_optimization()
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 4: INPUT PARSING (optimizer_service.py)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  parse_input_dict():
â”‚  â€¢ Auto-detects location from route_coordinates (if provided)
â”‚    â†’ Calls location_deriver.derive_location()
â”‚    â†’ Reverse geocodes first coordinate
â”‚    â†’ Gets country code
â”‚    â†’ Calls standard_resolver.resolve()
â”‚    â†’ Returns DesignStandard (IS, IEC, EN, NESC)
â”‚
â”‚  â€¢ Auto-detects wind zone from location (if not provided)
â”‚    â†’ Uses location_deriver for country-based defaults
â”‚
â”‚  â€¢ Auto-detects terrain from elevation profile (if not provided)
â”‚    â†’ Analyzes terrain_profile slopes
â”‚
â”‚  â€¢ Creates OptimizationInputs object
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 5: ROUTE DETECTION (optimizer_service.py)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  Decision Point:
â”‚  IF route_coordinates provided AND len >= 2:
â”‚    â†’ Route Optimization Path
â”‚  ELSE:
â”‚    â†’ Single-Tower Optimization Path
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     STEP 6A: ROUTE OPTIMIZATION PATH (route_optimizer.py)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  optimize_route():
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 6A.1: Terrain Profile Processing                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Merges terrain_profile into route_coordinates
â”‚  â€¢ Creates TerrainPoint objects with elevation
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 6A.2: Obstacle Detection                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Initializes ObstacleDetector
â”‚  â€¢ Calculates route bounding box
â”‚  â€¢ Queries OSM Overpass API:
â”‚    - Rivers, canals, drains, ditches, streams
â”‚    - Lakes, reservoirs, basins, wetlands
â”‚    - Highways (motorway, trunk, primary, secondary, tertiary)
â”‚  â€¢ Analyzes terrain slopes (> 30% = forbidden zone)
â”‚  â€¢ Creates ForbiddenZone objects with geometry
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 6A.3: Tower Placement (SectionBasedPlacer)        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  Phase 1: Corner Merging
â”‚  â€¢ Iterates through route coordinates
â”‚  â€¢ Calculates distance between consecutive corners
â”‚  â€¢ IF segment < 50m: MERGE (skip intermediate point)
â”‚  â€¢ Result: Simplified route with only significant corners
â”‚
â”‚  Phase 2: Define Sections
â”‚  â€¢ Breaks route into logical sections:
â”‚    - Start â†’ Corner 1
â”‚    - Corner 1 â†’ Corner 2
â”‚    - ...
â”‚    - Corner N â†’ End
â”‚  â€¢ Each section is a RouteSection object
â”‚
â”‚  Phase 3: Optimize Spans (With Slack Logic)
â”‚  FOR EACH SECTION:
â”‚    IF first OR last section:
â”‚      â†’ Apply Smart Slack Span Logic:
â”‚         â€¢ Attempt: target 150-200m for first/last span
â”‚         â€¢ IF valid: create uneven split
â”‚         â€¢ ELSE: fallback to uniform spans
â”‚    ELSE:
â”‚      â†’ Standard Rule:
â”‚         â€¢ num_spans = ceil(section_length / max_span)
â”‚         â€¢ actual_span = section_length / num_spans
â”‚         â€¢ IF actual_span < min_span AND num_spans > 1:
â”‚           â†’ Reduce num_spans
â”‚
â”‚  Phase 4: Precise Placement (Vector Math)
â”‚  FOR EACH SECTION:
â”‚    â€¢ Place 'anchor' tower at section end (corner)
â”‚      â†’ design_type = 'anchor'
â”‚    â€¢ Place (num_spans - 1) 'suspension' towers
â”‚      â†’ Interpolated between section start and end
â”‚      â†’ pos = start_coord + (unit_vector * span_index * actual_span)
â”‚      â†’ design_type = 'suspension'
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 6A.4: Smart Nudging (ObstacleDetector)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  FOR EACH PLACED TOWER:
â”‚    â€¢ proposed_distance = tower.distance_along_route_m
â”‚    â€¢ safe_pos = detector.get_safe_spot(proposed_distance, max_shift=100)
â”‚    â€¢ IF safe_pos != proposed_distance:
â”‚        â†’ NUDGE occurred
â”‚        â†’ Update tower coordinates
â”‚        â†’ Log: "[NUDGE] Tower moved from {old}m to {new}m to avoid {obstacle}"
â”‚    â€¢ IF ConstraintError raised:
â”‚        â†’ Log critical error
â”‚        â†’ Flag tower as 'VIOLATION'
â”‚        â†’ Place tower anyway (fallback)
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 6A.5: Tower Type Classification                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  FOR EACH TOWER:
â”‚    â€¢ Calculate deviation angle (vector math between prev/current/next)
â”‚    â€¢ Classify:
â”‚      - 0Â° - 3Â°: SUSPENSION
â”‚      - 3Â° - 60Â°: ANGLE
â”‚      - > 60Â° OR route endpoint: DEAD_END
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 6A.6: Individual Tower Optimization               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  FOR EACH TOWER:
â”‚    â€¢ Create PSOOptimizer instance
â”‚    â€¢ Run optimizer.optimize(tower_type)
â”‚    â€¢ Get OptimizationResult
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     STEP 6B: SINGLE-TOWER OPTIMIZATION PATH (optimizer_service.py)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  â€¢ Create CodalEngine (based on governing_standard)
â”‚  â€¢ Create PSOOptimizer
â”‚  â€¢ Run optimizer.optimize(tower_type)
â”‚  â€¢ Get OptimizationResult
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STEP 7: PSO OPTIMIZATION (pso_optimizer.py)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  PSO Algorithm:
â”‚
â”‚  Initialization:
â”‚  â€¢ Create swarm of particles (default: 30)
â”‚  â€¢ Each particle = [tower_height, base_width, span_length]
â”‚  â€¢ Randomize positions within bounds
â”‚  â€¢ Initialize velocities
â”‚
â”‚  Iteration Loop (default: 100 iterations):
â”‚  FOR EACH ITERATION:
â”‚    FOR EACH PARTICLE:
â”‚      â€¢ Decode position â†’ TowerDesign object
â”‚      â€¢ Clamp to bounds (height: 25-60m, span: 250-450m, etc.)
â”‚      
â”‚      â€¢ Safety Check:
â”‚        â†’ Call codal_engine.check_safety(design, inputs)
â”‚        â†’ Returns SafetyCheckResult (is_safe, violations)
â”‚        â†’ IF unsafe: apply VERY_LARGE_PENALTY
â”‚      
â”‚      â€¢ Cost Calculation:
â”‚        â†’ Call cost_engine.calculate_cost(design, inputs)
â”‚        â†’ Reads market_rates.py for country-specific rates
â”‚        â†’ Calculates:
â”‚          - Steel cost = weight Ã— steel_price_usd
â”‚          - Foundation cost = volume Ã— adjusted_cement_price
â”‚          - Erection cost = base Ã— labor_factor Ã— logistics_factor
â”‚        â†’ Returns total cost
â”‚      
â”‚      â€¢ Fitness = cost + penalty (if unsafe)
â”‚      
â”‚      â€¢ Update personal best (pbest)
â”‚      â€¢ Update global best (gbest)
â”‚      
â”‚      â€¢ Update velocity:
â”‚        v = wÃ—v + c1Ã—r1Ã—(pbest - x) + c2Ã—r2Ã—(gbest - x)
â”‚      
â”‚      â€¢ Update position:
â”‚        x = x + v
â”‚
â”‚  Return:
â”‚  â€¢ Best safe design found
â”‚  â€¢ IF no safe design: return conservative fallback design
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      STEP 8: SAFETY VALIDATION (codal_engine/base.py)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  check_safety():
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 8.1: Clearance Resolution                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Initialize ClearanceResolver(standard_code, voltage_kv)
â”‚  â€¢ Voltage Snapping:
â”‚    - 217kV â†’ 220kV tier
â”‚    - 110kV â†’ 132kV tier
â”‚    - > 400kV: use 400kV rules + 0.01m per kV above
â”‚  â€¢ Get required_clearance from GLOBAL_CLEARANCE_RULES
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 8.2: Electrical Clearance Check                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Calculate conductor sag (catenary equation)
â”‚  â€¢ Calculate minimum clearance to ground
â”‚  â€¢ Compare with required_clearance
â”‚  â€¢ IF clearance < required: VIOLATION
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 8.3: Structural Safety Check                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Check tower height bounds
â”‚  â€¢ Check base width ratio
â”‚  â€¢ Check foundation dimensions
â”‚  â€¢ Check span length bounds
â”‚
â”‚  Returns: SafetyCheckResult(is_safe, violations[])
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 9: COST CALCULATION (cost_engine.py)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  calculate_cost_with_breakdown():
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 9.1: Market Rates Lookup                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Extract country code from project_location
â”‚    â†’ _get_country_code_from_location()
â”‚    â†’ Maps "India" â†’ "IN", "USA" â†’ "US", etc.
â”‚  â€¢ Call get_rates_for_country(country_code)
â”‚    â†’ Reads backend/data/market_rates.py
â”‚    â†’ Returns: {steel_price_usd, cement_price_usd, labor_factor, logistics_factor, description}
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 9.2: Steel Cost                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Calculate steel weight:
â”‚    weight = k Ã— height Ã— base_width Ã— type_multiplier
â”‚    k = 0.035 (lattice factor)
â”‚    type_multiplier: suspension=1.0, angle=1.5, dead_end=2.5
â”‚  â€¢ IF ice_load: weight Ã— 1.35
â”‚  â€¢ steel_cost = weight Ã— steel_price_usd
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 9.3: Foundation Cost                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Calculate concrete volume:
â”‚    volume = 4 Ã— (length Ã— width Ã— depth)  # 4 footings
â”‚  â€¢ Adjust concrete rate by cement price:
â”‚    rate = 160 Ã— (cement_price_usd / 150.0)
â”‚  â€¢ foundation_cost = volume Ã— rate Ã— soil_factor
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 9.4: Erection Cost                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ base_erection = steel_cost Ã— 0.25
â”‚  â€¢ erection_cost = base_erection Ã— labor_factor Ã— logistics_factor
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 9.5: Land/ROW Cost                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Calculate based on tower footprint and ROW corridor
â”‚  â€¢ Uses regional land rates
â”‚
â”‚  Returns: (total_cost, breakdown_dict)
â”‚  breakdown_dict includes: market_rates, country_code, all costs
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     STEP 10: RESULT AGGREGATION (route_optimizer.py or canonical_converter)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  _aggregate_route_results() OR convert_to_canonical():
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 10.1: Line Summary                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Calculate totals:
â”‚    - total_towers
â”‚    - total_steel_tonnes
â”‚    - total_concrete_m3
â”‚    - avg_span_m
â”‚    - tallest_tower_m
â”‚    - deepest_foundation_m
â”‚    - tower_density_per_km
â”‚  â€¢ Calculate costs:
â”‚    - steel_total
â”‚    - foundation_total
â”‚    - erection_total
â”‚    - transport_total
â”‚    - land_ROW_total
â”‚    - total_project_cost
â”‚    - cost_per_km
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 10.2: Currency Resolution                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Call currency_resolver.resolve_currency()
â”‚  â€¢ IF location = "India" AND standard = "IS":
â”‚    â†’ Return INR with exchange rate
â”‚  â€¢ ELSE:
â”‚    â†’ Return USD
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 10.3: Safety Summary                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Generate risk advisories
â”‚  â€¢ Identify governing risks
â”‚  â€¢ List active design scenarios
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 10.4: Regional Context                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Get regional risks
â”‚  â€¢ Calculate confidence score
â”‚  â€¢ Identify confidence drivers
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Sub-Step 10.5: Market Rates Inclusion                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ Extract market_rates from cost breakdown
â”‚  â€¢ Include in CostBreakdownResponse
â”‚
â”‚  Creates: CanonicalOptimizationResult
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STEP 11: API RESPONSE (api.py)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  â€¢ Convert CanonicalOptimizationResult to dict (.dict())
â”‚  â€¢ Return JSON response
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 12: FRONTEND RENDERING (optimization-results.tsx)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  â€¢ Receive results object
â”‚  â€¢ Extract: towers[], spans[], line_summary, cost_breakdown, etc.
â”‚  â€¢ Render:
â”‚    - Tower list with details
â”‚    - Span analysis
â”‚    - Cost breakdown
â”‚    - Market rates reference
â”‚    - Safety summary
â”‚    - Risk advisories
â”‚    - Map visualization (MapViewer component)
â”‚  â€¢ MapViewer:
â”‚    - Renders route polyline
â”‚    - Renders tower markers (red dots)
â”‚    - Renders obstacles (rivers=blue, roads=orange, slopes=red)
â”‚    - Shows nudge badges for adjusted towers
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— Component Interactions

### **Service Dependency Graph**

```
optimizer_service.py
    â”œâ”€â”€â†’ location_deriver.py
    â”‚       â”œâ”€â”€â†’ reverse_geocode_simple() [external API]
    â”‚       â””â”€â”€â†’ standard_resolver.py
    â”‚               â””â”€â”€â†’ pycountry_convert (optional)
    â”‚
    â”œâ”€â”€â†’ route_optimizer.py
    â”‚       â”œâ”€â”€â†’ section_based_placer.py
    â”‚       â”‚       â”œâ”€â”€â†’ obstacle_detector.py
    â”‚       â”‚       â”‚       â”œâ”€â”€â†’ requests (OSM Overpass API)
    â”‚       â”‚       â”‚       â””â”€â”€â†’ shapely (geometric operations)
    â”‚       â”‚       â””â”€â”€â†’ tower_type_classifier.py
    â”‚       â”‚
    â”‚       â”œâ”€â”€â†’ pso_optimizer.py
    â”‚       â”‚       â”œâ”€â”€â†’ codal_engine/
    â”‚       â”‚       â”‚       â”œâ”€â”€â†’ clearance_rules.py
    â”‚       â”‚       â”‚       â””â”€â”€â†’ standard_resolver.py
    â”‚       â”‚       â””â”€â”€â†’ cost_engine.py
    â”‚       â”‚               â””â”€â”€â†’ market_rates.py
    â”‚       â”‚
    â”‚       â””â”€â”€â†’ canonical_converter.py
    â”‚               â”œâ”€â”€â†’ currency_resolver.py
    â”‚               â”œâ”€â”€â†’ confidence_scorer.py
    â”‚               â””â”€â”€â†’ cost_context.py
    â”‚
    â””â”€â”€â†’ canonical_converter.py (single-tower path)
```

---

## ğŸ§® Calculation Engines

### **1. PSO Optimizer (pso_optimizer.py)**

**Purpose**: Find optimal tower design parameters

**Algorithm**:
- **Search Space**: [tower_height, base_width, span_length]
- **Bounds**: 
  - Height: 25-60m
  - Base width: 25-40% of height
  - Span: 250-450m
- **Objective**: Minimize cost
- **Constraint**: Safety (hard constraint via penalty)

**Parameters**:
- Particles: 30 (default)
- Iterations: 100 (default)
- Inertia weight (w): 0.7
- Cognitive coefficient (c1): 1.5
- Social coefficient (c2): 1.5

**Output**: TowerDesign object with optimal parameters

---

### **2. Codal Engine (codal_engine/)**

**Purpose**: Validate designs against engineering standards

**Standards Supported**:
- **IS 5613** (India)
- **IEC 60826** (International)
- **EN 50341** (Europe)
- **NESC** (USA)

**Validation Checks**:
1. **Electrical Clearance**:
   - Calculate sag (catenary equation)
   - Minimum clearance = tower_height - sag - conductor_radius
   - Compare with required_clearance (voltage + standard dependent)
   
2. **Structural Safety**:
   - Tower height bounds
   - Base width ratio
   - Foundation dimensions
   - Span length bounds

**Clearance Rules** (from clearance_rules.py):
```
GLOBAL_CLEARANCE_RULES = {
    'IS': {
        132: {'default': 6.1, 'road': 6.1, 'railway': 14.6, 'river': 6.1},
        220: {'default': 7.0, 'road': 7.0, 'railway': 15.4, 'river': 7.0},
        400: {'default': 8.84, 'road': 8.84, 'railway': 17.9, 'river': 8.84},
    },
    'NESC': { ... },
    'EN': { ... },
    'IEC': { ... }
}
```

**Voltage Snapping**:
- 217kV â†’ uses 220kV rules
- 110kV â†’ uses 132kV rules
- > 400kV â†’ uses 400kV rules + 0.01m per kV above

---

### **3. Cost Engine (cost_engine.py)**

**Purpose**: Calculate total project cost

**Components**:

1. **Steel Cost**:
   ```
   weight_tonnes = 0.035 Ã— height Ã— base_width Ã— type_multiplier
   IF ice_load: weight Ã— 1.35
   steel_cost = weight Ã— steel_price_usd
   ```

2. **Foundation Cost**:
   ```
   volume_m3 = 4 Ã— (length Ã— width Ã— depth)
   rate = 160 Ã— (cement_price_usd / 150.0)
   foundation_cost = volume Ã— rate Ã— soil_factor
   ```

3. **Erection Cost**:
   ```
   base_erection = steel_cost Ã— 0.25
   erection_cost = base_erection Ã— labor_factor Ã— logistics_factor
   ```

4. **Land/ROW Cost**:
   ```
   tower_footprint_cost = area Ã— regional_land_rate
   corridor_cost = length Ã— corridor_width Ã— regional_land_rate
   ```

**Market Rates Source**: `backend/data/market_rates.py`
- Tier-based pricing (Tier 1-4)
- Country-specific overrides
- Fallback to global default

---

### **4. Obstacle Detector (obstacle_detector.py)**

**Purpose**: Detect and avoid obstacles along route

**Detection Methods**:

1. **OSM Overpass API Query**:
   ```python
   # Flowing Water
   way["waterway"~"river|canal|drain|ditch|stream"]
   
   # Standing Water
   way["natural"="water"]
   way["landuse"="reservoir|basin"]
   
   # Wetlands
   way["natural"="wetland"]
   
   # Major Roads
   way["highway"~"motorway|trunk|primary|secondary|tertiary"]
   ```

2. **Slope Analysis**:
   ```python
   FOR EACH terrain segment:
       slope = (elevation_end - elevation_start) / distance
       IF slope > 0.30 (30%):
           â†’ Mark as forbidden zone
   ```

3. **Smart Nudging**:
   ```python
   get_safe_spot(target_distance, max_shift=100):
       FOR shift in [5, 10, 15, ..., max_shift]:
           FOR direction in [forward, backward]:
               test_distance = target_distance Â± shift
               IF test_distance NOT in any ForbiddenZone:
                   â†’ Return test_distance
       â†’ Raise ConstraintError
   ```

---

### **5. Section-Based Placer (section_based_placer.py)**

**Purpose**: Intelligently place towers along route

**Phase 1: Corner Merging**
```python
FOR consecutive corners:
    distance = haversine(corner1, corner2)
    IF distance < 50m:
        â†’ MERGE (remove intermediate point)
```

**Phase 2: Define Sections**
```python
sections = []
FOR i in range(len(corners) - 1):
    section = RouteSection(
        start=corners[i],
        end=corners[i+1],
        length=haversine(corners[i], corners[i+1])
    )
    sections.append(section)
```

**Phase 3: Optimize Spans**
```python
FOR EACH section:
    IF first OR last section:
        â†’ Smart Slack Span Logic:
           target_span = 150-200m
           IF valid: create uneven split
           ELSE: uniform spans
    ELSE:
        â†’ Standard:
           num_spans = ceil(section_length / max_span)
           actual_span = section_length / num_spans
```

**Phase 4: Precise Placement**
```python
FOR EACH section:
    # Anchor at section end
    place_tower(section.end, type='anchor')
    
    # Suspension towers interpolated
    FOR span_index in range(1, num_spans):
        unit_vector = normalize(section.end - section.start)
        position = section.start + (unit_vector Ã— span_index Ã— actual_span)
        place_tower(position, type='suspension')
```

---

## ğŸ“¤ Output Generation

### **Canonical Format Structure**

```python
CanonicalOptimizationResult:
    â”œâ”€â”€ towers: List[TowerResponse]
    â”‚   â”œâ”€â”€ index: int
    â”‚   â”œâ”€â”€ distance_along_route_m: float
    â”‚   â”œâ”€â”€ latitude, longitude: float
    â”‚   â”œâ”€â”€ tower_type: str
    â”‚   â”œâ”€â”€ total_height_m: float
    â”‚   â”œâ”€â”€ base_width_m: float
    â”‚   â”œâ”€â”€ foundation_dimensions: dict
    â”‚   â”œâ”€â”€ steel_weight_kg: float
    â”‚   â”œâ”€â”€ costs: (steel, foundation, erection, transport, land, total)
    â”‚   â”œâ”€â”€ safety_status: "SAFE" | "GOVERNING"
    â”‚   â”œâ”€â”€ design_reason: str
    â”‚   â”œâ”€â”€ nudge_description: str (if nudged)
    â”‚   â””â”€â”€ original_distance_m: float (if nudged)
    â”‚
    â”œâ”€â”€ spans: List[SpanResponse]
    â”‚   â”œâ”€â”€ from_tower_index, to_tower_index: int
    â”‚   â”œâ”€â”€ span_length_m: float
    â”‚   â”œâ”€â”€ sag_m: float
    â”‚   â”œâ”€â”€ minimum_clearance_m: float
    â”‚   â”œâ”€â”€ clearance_margin_percent: float
    â”‚   â”œâ”€â”€ is_safe: bool
    â”‚   â””â”€â”€ governing_reason: str
    â”‚
    â”œâ”€â”€ line_summary: LineSummaryResponse
    â”‚   â”œâ”€â”€ route_length_km: float
    â”‚   â”œâ”€â”€ total_towers: int
    â”‚   â”œâ”€â”€ avg_span_m: float
    â”‚   â”œâ”€â”€ total_steel_tonnes: float
    â”‚   â”œâ”€â”€ total_concrete_m3: float
    â”‚   â”œâ”€â”€ total_project_cost: float
    â”‚   â””â”€â”€ cost_per_km: float
    â”‚
    â”œâ”€â”€ cost_breakdown: CostBreakdownResponse
    â”‚   â”œâ”€â”€ steel_total: float
    â”‚   â”œâ”€â”€ foundation_total: float
    â”‚   â”œâ”€â”€ erection_total: float
    â”‚   â”œâ”€â”€ transport_total: float
    â”‚   â”œâ”€â”€ land_ROW_total: float
    â”‚   â”œâ”€â”€ total_project_cost: float
    â”‚   â”œâ”€â”€ currency: str
    â”‚   â”œâ”€â”€ currency_symbol: str
    â”‚   â””â”€â”€ market_rates: dict
    â”‚       â”œâ”€â”€ steel_price_usd: float
    â”‚       â”œâ”€â”€ cement_price_usd: float
    â”‚       â”œâ”€â”€ labor_factor: float
    â”‚       â”œâ”€â”€ logistics_factor: float
    â”‚       â””â”€â”€ description: str
    â”‚
    â”œâ”€â”€ safety_summary: SafetySummaryResponse
    â”‚   â”œâ”€â”€ overall_status: str
    â”‚   â”œâ”€â”€ governing_risks: List[str]
    â”‚   â””â”€â”€ design_scenarios_applied: List[str]
    â”‚
    â”œâ”€â”€ regional_context: RegionalContextResponse
    â”‚   â”œâ”€â”€ governing_standard: str
    â”‚   â”œâ”€â”€ dominant_regional_risks: List[str]
    â”‚   â””â”€â”€ confidence: ConfidenceResponse
    â”‚
    â”œâ”€â”€ obstacles: List[dict]
    â”‚   â”œâ”€â”€ start_distance_m: float
    â”‚   â”œâ”€â”€ end_distance_m: float
    â”‚   â”œâ”€â”€ type: str ("river", "highway", "slope")
    â”‚   â”œâ”€â”€ name: str
    â”‚   â””â”€â”€ geometry: List[{lat, lon}]
    â”‚
    â””â”€â”€ warnings, advisories: List[dict]
```

---

## ğŸ” Missing Endpoints Summary

### **Critical Missing**
- None (all core functionality covered)

### **Nice-to-Have Missing**
1. `GET /docs` - OpenAPI documentation (FastAPI auto-generates at `/docs`, but should verify)
2. `GET /api/standards` - List available design standards
3. `GET /api/market-rates/{country_code}` - Preview market rates
4. `GET /api/geo-context?lat={lat}&lon={lon}` - Get geographic context for coordinates
5. `POST /api/export/pdf` - PDF report generation
6. `GET /api/projects` - List saved projects (requires database)
7. `POST /api/projects` - Save project (requires database)
8. `DELETE /api/projects/{id}` - Delete project (requires database)

---

## ğŸ“Š Key Data Transformations

1. **Frontend Form â†’ API Request**:
   - Enum validation
   - Type conversion (voltage to int)
   - Coordinate formatting

2. **API Request â†’ OptimizationInputs**:
   - Auto-detection of location, wind, terrain
   - Standard resolution
   - Input validation

3. **Route Coordinates â†’ Terrain Profile**:
   - Elevation extraction
   - Distance calculation (Haversine)
   - Slope analysis

4. **Terrain Profile â†’ Tower Positions**:
   - Section-based placement
   - Span optimization
   - Vector math interpolation

5. **Tower Positions â†’ Optimized Designs**:
   - PSO optimization
   - Safety validation
   - Cost calculation

6. **Optimized Designs â†’ Canonical Format**:
   - Aggregation
   - Currency conversion
   - Summary calculations

7. **Canonical Format â†’ Frontend Display**:
   - Component rendering
   - Map visualization
   - Excel export

---


